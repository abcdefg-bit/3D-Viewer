<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEP Viewer - Ver 1.0.5</title>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "occt-import-js": "https://unpkg.com/occt-import-js@0.0.12/dist/occt-import-js.js"
            }
        }
    </script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: #fff; font-family: monospace; }
        #ui { position: absolute; top: 10px; left: 10px; z-index: 1000; background: rgba(30,30,30,0.9); padding: 20px; border-radius: 8px; width: 300px; border: 1px solid #444; }
        #versionTag { font-size: 10px; color: #888; margin-bottom: 10px; display: block; }
        button { background: #28a745; color: white; padding: 15px; width: 100%; border: none; font-size: 16px; margin-top: 10px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        button:disabled { background: #555; cursor: not-allowed; }
        #log { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.85); color: #0f0; font-size: 11px; height: 200px; overflow-y: scroll; padding: 10px; border-top: 2px solid #0f0; box-sizing: border-box; }
        .log-ver { color: #ff00ff; font-weight: bold; } /* バージョン用カラー */
        .log-error { color: #ff4d4d; }
        .log-success { color: #00ff00; }
        .log-info { color: #00d4ff; }
        input[type="file"] { background: #333; padding: 10px; width: 100%; box-sizing: border-box; color: #fff; }
    </style>
</head>
<body>

    <div id="ui">
        <span id="versionTag">Build: 2026-02-22-1400</span>
        <strong style="font-size: 18px;">STEP VIEWER v1.0.5</strong><br><br>
        <input type="file" id="fileInput" accept=".step,.stp">
        <button id="loadBtn">読み込み開始</button>
    </div>

    <div id="log"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import initOpenCascade from 'occt-import-js';

        const APP_VERSION = "1.0.5";
        const BUILD_DATE = "2026-02-22 14:00";
        const logEl = document.getElementById('log');
        const loadBtn = document.getElementById('loadBtn');

        function addLog(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = `log-${type}`;
            line.innerHTML = `[${time}] ${msg}`;
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
        }

        // 起動時にバージョンを明示
        addLog(`=== アプリ起動 ===`, "ver");
        addLog(`バージョン: ${APP_VERSION}`, "ver");
        addLog(`ビルド日時: ${BUILD_DATE}`, "ver");
        addLog("Three.js シーンを初期化しています...");

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        camera.position.set(10, 10, 10);
        addLog("システム準備完了。ファイルを選択してください。", "success");

        const modelGroup = new THREE.Group();
        scene.add(modelGroup);

        loadBtn.onclick = async () => {
            const file = document.getElementById('fileInput').files[0];
            if (!file) {
                addLog("エラー: ファイルが未選択です", "error");
                return;
            }

            loadBtn.disabled = true;
            addLog(`ファイル読み込み開始: ${file.name}`);

            try {
                addLog("解析エンジンのロード中 (URL: unpkg.com)...");
                const occt = await initOpenCascade();
                addLog("解析エンジン接続成功", "success");

                const reader = new FileReader();
                reader.onload = async (e) => {
                    addLog("データ解析フェーズに移行します...");
                    const buffer = new Uint8Array(e.target.result);
                    const result = occt.ReadStepFile(buffer);
                    
                    if (!result || !result.meshes) throw new Error("STEPデータが空または無効です");

                    addLog(`解析成功 (メッシュ数: ${result.meshes.length})`, "success");
                    modelGroup.clear();

                    result.meshes.forEach(mesh => {
                        const geo = new THREE.BufferGeometry();
                        geo.setAttribute('position', new THREE.Float32BufferAttribute(mesh.attributes.position.array, 3));
                        if (mesh.attributes.normal) geo.setAttribute('normal', new THREE.Float32BufferAttribute(mesh.attributes.normal.array, 3));
                        modelGroup.add(new THREE.Mesh(geo, new THREE.MeshPhongMaterial({ color: 0x888888 })));
                    });

                    const box = new THREE.Box3().setFromObject(modelGroup);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3()).length();
                    controls.target.copy(center);
                    camera.position.copy(center).add(new THREE.Vector3(size, size, size));
                    controls.update();

                    addLog("レンダリング完了。画面を確認してください。", "success");
                    loadBtn.disabled = false;
                };
                reader.readAsArrayBuffer(file);
            } catch (err) {
                addLog(`CRITICAL ERROR: ${err.message}`, "error");
                loadBtn.disabled = false;
            }
        };

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
